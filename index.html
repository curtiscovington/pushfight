<html>
    <head>
        <title>Pushfight</title>
        <style>
            body {
                background: cyan;
            }
        </style>
    </head>
    <body>

        <div>
        <svg style="float:left" id="board" version="1.1"
            baseProfile="full"
            width="250" height="450"
            xmlns="http://www.w3.org/2000/svg">

        <rect class="tile B1" x="50" y="0" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        <rect class="tile C1" x="100" y="0" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>

        <rect class="tile A2" x="0" y="50" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        <rect class="tile B2" x="50" y="50" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        <rect class="tile C2" x="100" y="50" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
       
        <rect class="tile A3" x="0" y="100" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        <rect class="tile B3" x="50" y="100" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        <rect class="tile C3" x="100" y="100" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        <rect class="tile D3" x="150" y="100" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>

        <rect class="tile A4" x="0" y="150" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        <rect class="tile B4" x="50" y="150" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        <rect class="tile C4" x="100" y="150" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        <rect class="tile D4" x="150" y="150" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>

        <rect class="tile A5" x="0" y="200" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        <rect class="tile B5" x="50" y="200" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        <rect class="tile C5" x="100" y="200" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        <rect class="tile D5" x="150" y="200" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>

        <rect class="tile A6" x="0" y="250" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        <rect class="tile B6" x="50" y="250" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        <rect class="tile C6" x="100" y="250" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        <rect class="tile D6" x="150" y="250" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        
        
        <rect class="tile B7" x="50" y="300" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        <rect class="tile C7" x="100" y="300" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        <rect class="tile D7" x="150" y="300" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>

        <rect class="tile B8" x="50" y="350" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>
        <rect class="tile C8" x="100" y="350" width="50" height="50" stroke="black" fill="transparent" stroke-width="1"/>

        <text x="225" y="25" font-size="16" text-anchor="middle" fill="black">1</text>
        <text x="225" y="75" font-size="16" text-anchor="middle" fill="black">2</text>
        <text x="225" y="125" font-size="16" text-anchor="middle" fill="black">3</text>
        <text x="225" y="175" font-size="16" text-anchor="middle" fill="black">4</text>
        <text x="225" y="225" font-size="16" text-anchor="middle" fill="black">5</text>
        <text x="225" y="275" font-size="16" text-anchor="middle" fill="black">6</text>
        <text x="225" y="325" font-size="16" text-anchor="middle" fill="black">7</text>
        <text x="225" y="375" font-size="16" text-anchor="middle" fill="black">8</text>

        <text x="25" y="425" font-size="16" text-anchor="middle" fill="black">A</text>
        <text x="75" y="425" font-size="16" text-anchor="middle" fill="black">B</text>
        <text x="125" y="425" font-size="16" text-anchor="middle" fill="black">C</text>
        <text x="175" y="425" font-size="16" text-anchor="middle" fill="black">D</text>
        
        <rect id="fill" x="0" y="0" width="100%" height="100%"  fill="red" stroke-width="1"/>
        
        <rect class="black piece square A5" x="0" y="200" width="50" height="50" fill="black" stroke="white" stroke-width="1" />        
        <rect class="black piece square B5" x="50" y="200" width="50" height="50" fill="black" stroke="white" stroke-width="1" />
        <rect class="black piece square C5" x="100" y="200" width="50" height="50" fill="black" stroke="white" stroke-width="1" />
        <circle class="black piece round D5" cx="175" cy="225" r="25" fill="black" stroke="white" stroke-width="1" />
        <circle class="black piece round C6" cx="125" cy="275" r="25" fill="black" stroke="white" stroke-width="1" />

        <rect class="white piece square A4" x="0" y="150" width="50" height="50" fill="white" stroke="black" stroke-width="1" />
        <rect class="white piece square B4" x="50" y="150" width="50" height="50" fill="white" stroke="black" stroke-width="1" />
        <rect class="white piece square C4" x="100" y="150" width="50" height="50" fill="white" stroke="black" stroke-width="1" />
        <circle class="white piece round D4" cx="175" cy="175" r="25" fill="white" stroke="black" stroke-width="1" />
        <circle class="white piece round B3" cx="75" cy="125" r="25" fill="white" stroke="black" stroke-width="1" />
        <text id="anchor" x="25" y="25" font-size="15" text-anchor="middle" fill="red">X
        </text>
        </svg>

        <div id="log" style="float:left"></div>
        </div>

        <p style="clear:both" id="player"></p>
        <p id="turn"></p>
        <script type="text/javascript">
            let turn = 0;
            let isWhite = false;
            let isStarted = false;
            let ws = new WebSocket("ws://"+location.host+ "/ws");
            let selected = null;

            let whitePieces = [
                {
                    x: 0, y: 0,
                    element: null
                }
            ]

            ws.addEventListener("message", function(e) {
                if (e.data == "white") {
                    isStarted = true;
                    isWhite = true;
                    document.getElementById('fill').remove()
                    document.getElementById('player').innerHTML = "White";
                    setTurn()
                } else if (e.data == "black") {
                    isStarted = true;
                    isWhite = false;
                    document.getElementById('fill').remove()
                    document.getElementById('player').innerHTML = "Black";
                    setTurn();
                }
                else if (e.data == "end") {
                    selected = null;
                    turn++;
                    setTurn();
                } else if (e.data === "White Wins") {
                    document.getElementById("turn").innerHTML = "White Wins"
                } else if (e.data === "Black Wins") {
                    document.getElementById("turn").innerHTML = "Black Wins"
                } else if (e.data.match(/PUSH/g)) {
                    let l = document.getElementById("log");
                    let elem = document.createElement("p");
                    elem.innerHTML = e.data;
                    l.appendChild(elem);

                    let coords = e.data.split(' ');
                    coords.shift();
                    let x1 = _letterToInt(coords[0][0]);
                    let x2 = _letterToInt(coords[1][0]);
                    let y1 = +coords[0][1];
                    let y2 = +coords[1][1];

                    dx = x2 - x1;
                    dy = y2 - y1;

                    if (dy < 0) {
                        // up
                        moveDirection("up", x1, y1)
                    } else if (dy > 0) {
                        // down
                        moveDirection("down", x1, y1)
                    } else if (dx < 0) {
                        // left
                        moveDirection("left", x1, y1)
                    } else if (dx > 0) {
                        // right
                        moveDirection("right", x1, y1)
                    } 

                    let anchor = document.getElementById("anchor");
                    let tile = document.querySelector(".tile."+coords[1]);
                    let x = +tile.getAttribute("x");
                    let y = +tile.getAttribute("y");
                    
                    anchor.setAttributeNS(null, "x", x+25)
                    anchor.setAttributeNS(null, "y", y+25)
                   
                } else if (e.data.length == 5) {
                    console.log(e.data);
                    let l = document.getElementById("log");
                    let elem = document.createElement("p");
                    elem.innerHTML = e.data;
                    l.appendChild(elem);
                    coords = e.data.split(' ');
                    let tile = document.querySelector('.tile.'+coords[1])
                    let p = document.querySelector('.piece.'+coords[0]);

                    let x = +tile.getAttribute("x");
                    let y = +tile.getAttribute("y");
                    p.classList.remove(coords[0]);
                    p.classList.add(coords[1]);
                    if (p.classList.contains('round')) {
                        
                        p.setAttributeNS(null, "cx", x + 25)
                        p.setAttributeNS(null, "cy", y + 25)
                    } else {
                        p.setAttributeNS(null, "x", x)
                        p.setAttributeNS(null, "y", y)
                    }
                }
            });

            document.querySelectorAll(".tile").forEach(elem => elem.addEventListener("click", function(e) {
                if (selected !== null) {
                    let tile = e.target;
                    let x = +tile.getAttribute("x");
                    let y = +tile.getAttribute("y");

                    if (selected instanceof SVGCircleElement) {
                        let cx = ((+selected.getAttribute("cx")) - 25)/50;
                        let cy = ((+selected.getAttribute("cy")) - 25)/50 + 1;
                      
                        ws.send(_convertToCommand(cx, cy, x/50, y/50+1))
                        
                    } else if (selected instanceof SVGRectElement) {
                        let cx = ((+selected.getAttribute("x")))/50;
                        let cy = ((+selected.getAttribute("y")))/50 + 1;
                        ws.send(_convertToCommand(cx, cy, x/50, y/50+1));
                        
                    }
                    selected.setAttributeNS(null, "stroke", "black")
                    selected = null;
                    
                }
            }));

            document.querySelectorAll(".piece").forEach(elem => elem.addEventListener("click", function(e) {
                if (selected != null && selected.classList.contains("square")) {
                    let cx = ((+selected.getAttribute("x")))/50;
                    let cy = ((+selected.getAttribute("y")))/50 + 1;
                    let x;
                    let y;
                    if (e.target instanceof SVGRectElement) {
                        x = ((+e.target.getAttribute("x")))/50;
                        y = ((+e.target.getAttribute("y")))/50 + 1;
                    } else {
                        x = ((+e.target.getAttribute("cx")) - 25)/50;
                        y = ((+e.target.getAttribute("cy")) - 25)/50 + 1;
                    }
                    ws.send(_convertToCommand(cx, cy, x, y));

                } else if ((isWhite && e.target.classList.contains("white")) || (!isWhite && e.target.classList.contains("black"))) {
                selected = e.target;
                selected.setAttributeNS(null, "stroke", "red");
                }
            }));

            function _convertToCommand(cx, cy, x, y) {
                console.log(cx, cy, x, y)
                return `${_intToLetter(cx)}${cy} ${_intToLetter(x)}${y}`;
            }

            function _intToLetter(i) {
                let letters = ['A', 'B', 'C', 'D'];

                return letters[i];
            }
            function _letterToInt(i) {
                let ints = {
                    "A": 0,
                    "B": 1,
                    "C": 2,
                    "D": 3
                };

                return ints[i];
            }
            function setTurn() {
                if (turn % 2 == 0) {
                    document.getElementById('turn').innerHTML = "White's Turn";
                } else {
                    document.getElementById('turn').innerHTML = "Black's Turn";
                }
            }

            function moveDirection(dir, x, y, lastCoords) { 
                coords = _intToLetter(x) + y;
                console.log(x, y)
                if (dir == "up") {
                    let tile = document.querySelector('.tile.'+coords)
                    if (document.querySelector(".piece."+coords) !== null) {
                        let next = moveDirection("up", x, y-1, coords)
                        // nextCoords = _intToLetter(x) + (y-1);
                        if (typeof lastCoords != "undefined") {
                            return _movePiece(next, lastCoords)
                        }
                        
                    } else {
                        return _movePiece(coords, lastCoords)
                    }
                } else if (dir == "down") {
                    let tile = document.querySelector('.tile.'+coords)
                    if (document.querySelector(".piece."+coords) !== null) {
                        let next = moveDirection("down", x, y+1, coords)
                        // nextCoords = _intToLetter(x) + (y-1);
                        if (typeof lastCoords != "undefined") {
                            return _movePiece(next, lastCoords)
                        }
                        
                    } else {
                        return _movePiece(coords, lastCoords)
                    }
                } else if (dir == "left") {
                    let tile = document.querySelector('.tile.'+coords)
                    if (document.querySelector(".piece."+coords) !== null) {
                        let next = moveDirection("left", x-1, y, coords)
                        // nextCoords = _intToLetter(x) + (y-1);
                        if (typeof lastCoords != "undefined") {
                            return _movePiece(next, lastCoords)
                        }
                        
                    } else {
                        return _movePiece(coords, lastCoords)
                    }
                } else if (dir == "left") {
                    let tile = document.querySelector('.tile.'+coords)
                    if (document.querySelector(".piece."+coords) !== null) {
                        let next = moveDirection("right", x+1, y, coords)
                        // nextCoords = _intToLetter(x) + (y-1);
                        if (typeof lastCoords != "undefined") {
                            return _movePiece(next, lastCoords)
                        }
                        
                    } else {
                        return _movePiece(coords, lastCoords)
                    }
                }
            }

            function _movePiece(coords, fromCoords) {
                let p = document.querySelector(".piece."+fromCoords)
                console.log(coords, fromCoords)
                        let tile = document.querySelector(".tile."+coords)
                        let tx = +tile.getAttribute("x");
                        let ty = +tile.getAttribute("y");
                        p.classList.remove(fromCoords);
                        p.classList.add(coords);
                        if (p instanceof SVGCircleElement) {
        
                            p.setAttributeNS(null, "cx", tx + 25)
                            p.setAttributeNS(null, "cy", ty + 25)
                        } else {
                            p.setAttributeNS(null, "x", tx)
                            p.setAttributeNS(null, "y", ty)
                        }

                        return fromCoords;
            }
        </script>
    </body>
</html>